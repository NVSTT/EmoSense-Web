<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –æ–Ω–ª–∞–π–Ω</title>
<link rel="stylesheet" href="/static/css/styles.css">
<script src="/static/js/scripts.js" defer></script>
</head>
<body>
    <div class="container">
        <h1>üß† –¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –æ–Ω–ª–∞–π–Ω</h1>
        <p>–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç ‚Äî –ò–ò –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –µ–≥–æ —ç–º–æ—Ü–∏–∏!</p>
        {% if current_user %}
        <div class="user-info">
            <span>–ü—Ä–∏–≤–µ—Ç, {{ current_user.username }}!</span>
            <div class="user-actions">
                <button onclick="editProfile()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                <button onclick="logout()" class="logout-btn">–í—ã–π—Ç–∏</button>
                <button onclick="deleteAccount()" class="delete-btn">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
        </div>
        {% else %}
        <div class="auth-section">
            <button onclick="showLogin()" class="auth-btn">–í–æ–π—Ç–∏</button>
            <button onclick="showRegister()" class="auth-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form method="POST" enctype="multipart/form-data">
            <textarea name="post" placeholder="–ü—Ä–∏–º–µ—Ä: –í —Ç–æ–º–ª–µ–Ω—å—è—Ö –≥—Ä—É—Å—Ç–∏ –±–µ–∑–Ω–∞–¥–µ–∂–Ω–æ–π...">{{ request.form.get('post', '') }}</textarea><br>
            {% if current_user %}
            <div class="file-upload">
                <label for="file">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª (.txt):</label>
                <input type="file" name="file" id="file" accept=".txt">
            </div><br>
            {% endif %}

            <div class="toggle-switch">
                <input type="radio" id="objective" name="analysis_type" value="objective" {{ 'checked' if analysis_type == 'objective' else '' }}>
                <label for="objective">–û–±—ä–µ–∫—Ç–∏–≤–Ω–æ (RuBERT)</label>
                <input type="radio" id="subjective" name="analysis_type" value="subjective" {{ 'checked' if analysis_type == 'subjective' else '' }}>
                <label for="subjective">–°—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ (LLM)</label>
            </div>

            <button type="submit">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç</button>
        </form>

        <div class="note" id="note">
            {% if analysis_type == 'objective' %}
                üí° –°–æ–≤–µ—Ç: –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ "I'm happy", "This is terrible", "It's okay" - –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å RuBERT (–º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥)
            {% else %}
                üí° –°–æ–≤–µ—Ç: –ø–∏—à–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ - —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å LLM (—á–µ–ª–æ–≤–µ–∫–æ–ø–æ–¥–æ–±–Ω—ã–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è)
            {% endif %}
        </div>

        <div class="loader" id="loader" style="display: none;">
            <div class="spinner"></div>
            <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç...</p>
        </div>


        {% if result %}
        <div class="result {{ result.sentiment }}">
            <strong>–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:</strong> {{ result.sentiment_text }}<br><br>
            <div class="emotion-bars">
                <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏–π:</h3>
                {% for emotion, score in result.emotion_data.items() %}
                <div class="emotion-bar">
                    <span>{{ emotion.capitalize() }}: {{ "%.1f"|format(score * 100) }}%</span>
                    <div class="progress-bar">
                        <div class="progress-fill {{ emotion }}-fill" data-width="{{ (score * 100) }}"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <strong>–í–∞—à –ø–æ—Å—Ç:</strong><br>"<em>{{ result.post }}</em>"<br>
            <p></p>
            {% if current_user %}
            <strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ò–ò:</strong> {{ result.comment }}<br><br>
            <strong>–ü–æ—è—Å–Ω–µ–Ω–∏–µ:</strong> {{ result.explanation }}
            {% else %}
            <div class="premium-notice">
                <p>üîí <strong>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!</strong></p>
                <p>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å:</p>
                <ul>
                    <li>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ò–ò</li>
                    <li>–ü–æ–¥—Ä–æ–±–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è</li>
                    <li>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞</li>
                    <li>–ó–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤</li>
                </ul>
                <button onclick="showRegister()" class="premium-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                <button onclick="showLogin()" class="premium-btn">–í–æ–π—Ç–∏</button>
            </div>
            {% endif %}
        </div>
        {% if current_user %}
        <div class="full-reasoning">
            <h4>ü§ñ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –º–Ω–µ–Ω–∏–µ –ò–ò</h4>
            <p>{{ result.full_reasoning }}</p>
        </div>
        {% endif %}
        {% endif %}

        {% if result and current_user %}
        <div class="resize-section">
            <h3>‚ú® –ò–∑–º–µ–Ω–∏—Ç—å —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞</h3>
            <form method="POST" class="resize-form">
                <input type="hidden" name="post" value="{{ result.post }}">
                <input type="hidden" name="analysis_type" value="{{ result.analysis_type }}">
                <div class="resize-controls">
                    <label for="resize_sentiment">–ù–æ–≤–∞—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:</label>
                    <select name="resize_sentiment" id="resize_sentiment">
                        <option value="positive">–ü–æ–∑–∏—Ç–∏–≤–Ω–∞—è</option>
                        <option value="negative">–ù–µ–≥–∞—Ç–∏–≤–Ω–∞—è</option>
                        <option value="neutral">–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è</option>
                    </select>
                    <label for="resize_length">–î–ª–∏–Ω–∞ (—Å–ª–æ–≤):</label>
                    <input type="number" name="resize_length" id="resize_length" min="1" max="100" value="10">
                    <button type="submit" class="resize-btn">–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
                </div>
            </form>
            {% if result.resized_text %}
            <div class="resized-result">
                <h4>–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</h4>
                <p>"<em>{{ result.resized_text }}</em>"</p>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <form id="editProfileForm">
                <input type="text" id="editUsername" placeholder="–ù–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required><br>
                <input type="email" id="editEmail" placeholder="–ù–æ–≤—ã–π email" required><br>
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div id="deleteAccountModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDeleteModal()">&times;</span>
            <h2>–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h2>
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            <button onclick="confirmDelete()" class="delete-btn">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
            <button onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        function editProfile() {
            document.getElementById('editProfileModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editProfileModal').style.display = 'none';
        }

        function deleteAccount() {
            document.getElementById('deleteAccountModal').style.display = 'block';
        }

        function closeDeleteModal() {
            document.getElementById('deleteAccountModal').style.display = 'none';
        }

        function logout() {
            // –û—á–∏—Å—Ç–∫–∞ –∫—É–∫–∏ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ dashboard
            document.cookie = 'access_token_cookie=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/dashboard';
        }

        function showLogin() {
            window.location.href = '/login';
        }

        function showRegister() {
            window.location.href = '/register';
        }

        document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('editUsername').value;
            const email = document.getElementById('editEmail').value;

            const response = await fetch('/auth/update_profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email })
            });

            const data = await response.json();
            if (response.ok) {
                alert('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!');
                location.reload();
            } else {
                alert(data.message);
            }
        });

        async function confirmDelete() {
            const response = await fetch('/auth/delete_account', {
                method: 'DELETE'
            });

            const data = await response.json();
            if (response.ok) {
                alert('–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª–µ–Ω!');
                logout();
            } else {
                alert(data.message);
            }
        }
    </script>
</body>
</html>